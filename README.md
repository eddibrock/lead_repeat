# lead_repeat
Доработка фиксации повторных обращений (лидов)

Как сейчас работает:

1. Создаётся лид.  
  Не имеет значения как он создался, автоматически или вручную - работа с дубликатами начинается уже после создания лида.

2. ПОЛУЧЕНИЕ полей для поиска дубликатов 
  Получаем ифнормацию об 2-х полях этого лида (телефон и почта)
  Если есть контакт то его значения полей тоже участвуют в поиске дубликатов (привязался после создания лида например)

3. Поиск дубликатов 
  найди дубли по всем сущностям (кроме сделок)
  найти сделки, если есть контакт.

4. Запись информации (имеет подпункты a,b,c)
  записать в новый лид повторы (лиды, сделки и контакты)
  Присвоить ему свойство что он "Дубликат"

  (По контактам отдельная задача 1 тут , объясняющая принцип записи дублей контактов)
 
a). Действия с лидами-дубликатами 
  дубликатам после фильтра и после связи с новым лидом присваивается статус Дубля

б). Действия с лидами-дубликатами из "агенства" 
 Если статус дубликата CONVERTED или 'клиент агенства' И Если Источник = 'агенство'
 такой лид будет отображаться в карточке нового лида особым образом (выделен другим цветом)

с). Присвоение ответственного для нового лида 
 взять ответственного из сделки
 если нет (сделок) то берётся ответственный по контакту (свежему контакту)
 и в конце, если ничего из перечисленного выше нету, то берётся или уже привязанный к
 новому лид, или берётся самый свежий из найденных лидов

     
Отличия старого (на облаке) функционала от нового (коробка). Без технических подробностей. Так же, могут быть неточности в описании старого функционала, если они есть то помогите поправить:)



Область (этап)	на облаке	на коробке
 Сбор данных для поиска	Данные для поиска берутся из 2-х стандартных полей (PHONE и EMAIL все значения)	
теперь к стандартным полям добавляется информация из полей контакта (если у нового лида привязан контакт).

Такая архитектура гарантирует, что новые лиды без заполненных полей, но с контактом тоже будут учавствовать в поиске дубликатов

Поиск	
поиск останавливается при первом совпадении какого либо поля в повторяемых сущностях
Без остановки
Изменение лида	     
Дубликаты лидов добавляются в виде комментария

     
Теперь для дубликатов (сделок и лидов) есть свои собственные пользовательские поля, с правильным отображением и возможностью их чистить по клику

Изменение лида	     
Новому Лиду присваивается один из совпавших контактов (это не дубль а именно совпавший)

       Если контакт уже привязан к новому лиду то он и останется, даже если найдены совпавшие контакты
Изменение лида (клиент агенства)	     
Клиент агенства (Лид) добавлялся к новому лиду в виде специально выделенного комментария

     
Лид агенства теперь вычисляется при каждом открытии карточки лида http://joxi.ru/D2P76l4TqykoZm .

Если Лид-дубликат, привязанный к новому лиду потеряет статус «клиент агенства» или источник «агенство» то и отображаться в карточке нового лида он будет как обычный лид

Изменение лида (ответственный) 


Если пользователь не активен, он будет замещён его руководителем, однако, если и он тоже не активен то всё :) 


теперь проверка активности идёт вплоть до главного подразделения, пока, наконец не будет найден активный руководитель 


Изменения лида
(запись контактов)
Из найденных дублей контактов записывается один
Дополнительно, найденные контакты записываются и в поле "Связанные контакты", как лиды и сделки. Подробнее тут
