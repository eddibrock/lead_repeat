# lead_repeat
Доработка фиксации повторных обращений (лидов)

Как сейчас работает:

1. Создаётся лид.  
  Не имеет значения как он создался, автоматически или вручную - работа с дубликатами начинается уже после создания лида.

2. ПОЛУЧЕНИЕ полей для поиска дубликатов 
  Получаем ифнормацию об 2-х полях этого лида (телефон и почта)
  Если есть контакт то его значения полей тоже участвуют в поиске дубликатов (привязался после создания лида например)

3. Поиск дубликатов 
  найди дубли по всем сущностям (кроме сделок)
  найти сделки, если есть контакт.

4. Запись информации (имеет подпункты a,b,c)
  записать в новый лид повторы (лиды, сделки и контакты)
  Присвоить ему свойство что он "Дубликат"

  (По контактам отдельная задача 1 тут , объясняющая принцип записи дублей контактов)
 
a). Действия с лидами-дубликатами 
  дубликатам после фильтра и после связи с новым лидом присваивается статус Дубля

б). Действия с лидами-дубликатами из "агенства" 
 Если статус дубликата CONVERTED или 'клиент агенства' И Если Источник = 'агенство'
 такой лид будет отображаться в карточке нового лида особым образом (выделен другим цветом)

с). Присвоение ответственного для нового лида 
 взять ответственного из сделки
 если нет (сделок) то берётся ответственный по контакту (свежему контакту)
 и в конце, если ничего из перечисленного выше нету, то берётся или уже привязанный к
 новому лид, или берётся самый свежий из найденных лидов

     
